<?phpinclude_once TEMPLATE_PATH.'/site/helper/format.php';$project = $SOUP->get('project');$followers = $SOUP->get('followers');$followerInvites = $SOUP->get('followerInvites');// only organizers/creator can edit followers$hasEditPermission = ( Session::isAdmin() ||					ProjectUser::isOrganizer(Session::getUserID(), $project->getID()) ||					ProjectUser::isCreator(Session::getUserID(), $project->getID()) );// any contributor or above can invite followers$hasCreatePermission = ( Session::isAdmin() ||					ProjectUser::isOrganizer(Session::getUserID(), $project->getID()) ||					ProjectUser::isCreator(Session::getUserID(), $project->getID()) ||					ProjectUser::isContributor(Session::getUserID(), $project->getID()) );$fork = $SOUP->fork();$fork->set('id', 'followers');$fork->set('title', 'Followers');$fork->set('creatable', $hasCreatePermission);$fork->set('createLabel', 'Invite Followers');$fork->set('editable', $hasEditPermission);$fork->set('editLabel', 'Edit Followers');$fork->set('extraButton', $hasCreatePermission);$fork->set('extraButtonLabel', 'Show Invited');$fork->startBlockSet('body');?><script type="text/javascript">$(document).ready(function(){<?php if($hasEditPermission): ?>	$("#followers .editButton").click(function(){		var buttons = $("#followers li.follower input[type='button']");		if($(buttons).is(":hidden")) {			$(buttons).fadeIn();		} else {			$(buttons).fadeOut();		}	});		$("#followers input.ban").click(function(){		var id = $(this).attr('id').substring(4);		buildPost({			'processPage': '<?= Url::peopleProcess($project->getID()) ?>',			'info': {				'action': 'ban',				'userID': id			},			'buttonID': $(this)		});	});		$("#followers input.organizer").click(function(){		var id = $(this).attr('id').substring(10);		buildPost({			'processPage': '<?= Url::peopleProcess($project->getID()) ?>',			'info': {				'action': 'make-organizer',				'userID': id			},			'buttonID': $(this)		});	});	<?php endif; ?><?php if($hasCreatePermission): ?>	$('#followers .extraButton').click(function() {		var invited = $("#followers li.invited");		if($(invited).is(":hidden")) {			$('#followers li.none').hide();			$(invited).fadeIn();		} else {			$(invited).hide();			$('#followers li.none').show();		}	});			$('#followers div.invite-box').dialog({		autoOpen: false,		title: 'View Follower Invitation',		modal: true,		width: 500	});		$('#followers .viewInvite').click(function(){		var id = $(this).attr('id').substring(11);		$('#invite-box-'+id).dialog('open');	});		$("#followers .createButton").click(function(){		var invite = $("#followers .invite");		var view = $("#followers .view");		toggleEditView(view, invite);		if($(view).is(":hidden"))			$('#txtInviteFollowers').focus();	});		$("#btnCancelFollowers").click(function(){		$("#followers .invite").hide();		$("#followers .view").fadeIn();	});			$( "#txtInviteFollowers" )		// don't navigate away from the field on tab when selecting an item		.bind( "keydown", function( event ) {			if ( event.keyCode === $.ui.keyCode.TAB &&					$( this ).data( "autocomplete" ).menu.active ) {				event.preventDefault();			}		})		.autocomplete({			source: function( request, response ) {				$.getJSON( '<?= Url::peopleSearch($project->getID()) ?>/not-affiliated', {					term: extractLast( request.term )				}, response );			},			search: function() {				// custom minLength				var term = extractLast( this.value );				if ( term.length < 2 ) {					return false;				}			},			focus: function() {				// prevent value inserted on focus				return false;			},			select: function( event, ui ) {				var terms = split( this.value );				// remove the current input				terms.pop();				// add the selected item				terms.push( ui.item.value );				// add placeholder to get the comma-and-space at the end				terms.push( "" );				this.value = terms.join( ", " );				return false;			}		});			$('#btnInviteFollowers').click(function() {		buildPost({			'processPage': '<?= Url::peopleProcess($project->getID()) ?>',			'info': {				'action': 'invite-followers',				'invitees': $('#txtInviteFollowers').val(),				'message': $('#txtInviteFollowersMessage').val()			},			'buttonID': '#btnInviteFollowers'		});	});<?php endif; ?>});</script><div class="view"><ul class="segmented-list users"><?php // followersif(empty($followers)) {	echo '<li class="none">(none)</li>';} else {	//echo '<ul class="segmented-list users">';	foreach($followers as $f) {		echo '<li class="follower">';		if($hasEditPermission) {			echo '<input id="ban-'.$f->getID().'" type="button" class="ban hidden" value="Ban" />';			echo '<input id="organizer-'.$f->getID().'" type="button" class="organizer hidden" value="Make Organizer" />';		}		echo formatUserPicture($f->getID(), 'small');		echo '<h6 class="primary">'.formatUserLink($f->getID()).'</h6>';		echo '<p class="secondary">follower</p>';		echo '</li>';	}	//echo '</ul>';} // follower invitesif(!empty($followerInvites)) {	foreach($followerInvites as $fi) {		// don't list accepted invites		if($fi->getResponse() == Invitation::ACCEPTED) {			continue;		}				echo '<li class="invited">';		// View Invitation button		echo '<input id="invitation-'.$fi->getID().'" type="button" class="viewInvite" value="View Invitation" />';		// invite box		echo '<div id="invite-box-'.$fi->getID().'" class="invite-box hidden">';		echo '<p>invitation sent '.formatTimeTag($fi->getDateCreated()).' by '.formatUserLink($fi->getInviterID()).'</p>';		if($fi->getInvitationMessage() != null)			echo '<blockquote>'.formatInvitationMessage($fi->getInvitationMessage()).'</blockquote>';		if($fi->getResponse() == Invitation::DECLINED) {			echo '<p><span class="bad">declined</span> '.formatTimeTag($fi->getDateResponded()).'</p>';			if($fi->getResponseMessage() != null)				echo '<blockquote>'.formatInvitationMessage($fi->getResponseMessage()).'</blockquote>';		} else {			echo '<p>(no response yet)</p>';		}		echo '</div>';				// invitee picture and username		if($fi->getInviteeID() != null) {			echo formatUserPicture($fi->getInviteeID(), 'small');			echo '<h6 class="primary">'.formatUserLink($fi->getInviteeID()).'</h6>';		} else {			echo '<h6 class="primary"><a href="mailto:'.$fi->getInviteeEmail().'">'.$fi->getInviteeEmail().'</a></h6>';		}		// response		if($fi->getResponse() == Invitation::DECLINED) {			echo '<p class="secondary"><span class="bad">declined</span></p>';		} else {			echo '<p class="secondary">invited</p>';		}		echo '</li>';	}}?></ul></div><?php if($hasCreatePermission): ?><div class="invite hidden">	<div class="clear">		<label for="txtInviteFollowers">People to Invite<span class="required">*</span></label>		<div class="input">			<input type="text" id="txtInviteFollowers" />			<p>Usernames or email addresses, separated by commas</p>		</div>	</div>	<div class="clear">		<label for="txtInviteFollowersMessage">Message</label>		<div class="input">			<textarea id="txtInviteFollowersMessage"></textarea>			<p>Why the recipient(s) should follow this project</p>		</div>	</div>		<div class="clear">		<div class="input">			<input type="button" id="btnInviteFollowers" value="Invite" />			<input type="button" id="btnCancelFollowers" value="Cancel" />		</div>	</div></div><?php endif; ?><?php$fork->endBlockSet();$fork->render('site/partial/panel');